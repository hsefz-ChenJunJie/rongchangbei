# AI 对话应用前端开发文档

## 概述

本文档为 AI 对话应用的前端开发指南。系统通过 WebSocket 与后端实时通信，支持语音输入、智能对话生成和用户反馈处理。

## 界面设计和状态管理

### 主界面设计
- **预定对话区域**：允许用户预先设置对话情景和回答数量，保存为草稿
- **临时对话按钮**：直接开始新对话，跳转到对话页面
- **对话历史**：显示之前的对话记录（可选功能）

### 对话页面状态
- **处理音频中**：显示录音动画和暂停按钮
- **自动暂停中**：3秒静音触发，继续录音但不发送音频流，检测到语音立即恢复
- **手动暂停中**：用户主动暂停，停止录音，显示继续和结束按钮，可以输入修改建议
- 任何时候都可以修改对话情景、意见倾向和建议回答数量。

## 核心功能循环

### 完整对话流程

#### 阶段 1：对话初始化
1. 用户在主界面选择预定的对话，点击"开始对话"按钮；或者选择开始临时对话。
2. 前端发送对话开始事件到后端
3. 界面切换到录音状态

#### 阶段 2：语音输入处理
1. 用户开始录音（点击按钮或语音激活）
2. 前端持续发送音频流到后端
3. 检测到 3 秒静音时，发送自动暂停事件，继续录音但停止发送音频流
4. 用户手动暂停时，发送手动暂停事件，停止录音
5. **注意**：避免重复发送暂停事件

#### 阶段 3：用户反馈收集
1. 用户可随时输入对话意见倾向并发送
2. 在暂停期间，用户可输入对AI回复的修改建议


#### 阶段 4：AI 回复处理
1. 接收后端返回的多个AI回答建议
2. 在界面展示所有回答选项
3. 用户从中选择满意的回答
4. 将选中回答转换为语音播放
5. 用户决定是否继续对话

#### 阶段 5：对话继续或结束
- 继续对话：发送继续事件，返回阶段 2
- 结束对话：发送结束事件，清理界面状态

### 重要注意事项

- **会话ID管理**：每个对话都有唯一ID，前端需要在所有事件中携带此ID
- **防重复发送**：确保暂停事件不会在短时间内重复发送
- **状态管理**：对话状态有三种："处理音频中"、"自动暂停中"、"手动暂停中"
- **音频处理**：音频数据需要 base64 编码后发送
- **静音检测**：实现 3 秒静音自动暂停功能
- **自动恢复**：自动暂停状态下检测到语音立即发送继续事件
- **LLM重发**：暂停状态下修改情景、意见、修改建议会触发LLM请求重发

## WebSocket 事件通信

### 连接地址
使用 ws 协议，端口为 8000

### 事件字段规范说明
所有WebSocket事件都遵循必需和可选字段规范：
- **[必需]** 字段：必须包含，不能为空或null
- **[可选]** 字段：可以省略，或设置为空值
- 字段验证失败将返回错误事件
- session_id在对话开始事件中不需要，其他事件均为必需

### 前端发送的事件

#### 对话开始
```json
{
  "type": "conversation_start", // [必需]
  "data": {
    "scenario_description": "对话情景描述文本", // [可选] 
    "response_count": 3 // [必需] 1-5之间的整数
  }
}
```

#### 音频流
```json
{
  "type": "audio_stream", // [必需]
  "data": {
    "session_id": "会话唯一ID", // [必需] 会话创建后获得
    "audio_chunk": "base64编码的音频数据" // [必需] 音频数据块
  }
}
```

#### 对话控制
- 自动暂停（3秒静音触发）：
```json
{
  "type": "conversation_pause", // [必需]
  "data": {
    "session_id": "会话ID", // [必需]
    "pause_type": "auto" // [必需] 暂停类型：auto=自动暂停，manual=手动暂停
  }
}
```
- 手动暂停：
```json
{
  "type": "conversation_pause", // [必需]
  "data": {
    "session_id": "会话ID", // [必需]
    "pause_type": "manual" // [必需] 暂停类型：auto=自动暂停，manual=手动暂停
  }
}
```
- 继续：
```json
{
  "type": "conversation_resume", // [必需]
  "data": {
    "session_id": "会话ID" // [必需]
  }
}
```
- 结束：
```json
{
  "type": "conversation_end", // [必需]
  "data": {
    "session_id": "会话ID" // [必需]
  }
}
```

#### 用户反馈
- 用户意见：
```json
{
  "type": "user_opinion", // [必需]
  "data": {
    "session_id": "会话ID", // [必需]
    "opinion": "意见文本" // [必需] 用户的意见倾向
  }
}
```
- 修改建议：
```json
{
  "type": "user_modification", // [必需]
  "data": {
    "session_id": "会话ID", // [必需]
    "modification": "修改建议文本" // [必需] 对AI回复的修改意见
  }
}
```
- 补充情景：
```json
{
  "type": "scenario_supplement", // [必需]
  "data": {
    "session_id": "会话ID", // [必需]
    "supplement": "补充情景描述" // [必需] 补充的对话情景信息
  }
}
```
- 修改回答数量：
```json
{
  "type": "response_count_update", // [必需]
  "data": {
    "session_id": "会话ID", // [必需]
    "response_count": 4 // [必需] 新的建议回答数量，1-5之间的整数
  }
}
```

### 后端返回的事件

#### 会话创建确认
```json
{
  "type": "session_created", // [必需]
  "data": {
    "session_id": "生成的唯一会话ID" // [必需] 后续所有操作需要此ID
  }
}
```

#### AI回复
```json
{
  "type": "llm_response", // [必需]
  "data": {
    "session_id": "会话ID", // [必需]
    "suggestions": ["建议回答1", "建议回答2", "建议回答3"], // [必需] 回答建议数组
    "request_id": "请求唯一标识" // [可选] 用于请求追踪
  }
}
```

#### 状态更新
```json
{
  "type": "status_update", // [必需]
  "data": {
    "session_id": "会话ID", // [必需]
    "status": "processing_audio|auto_paused|manual_paused", // [必需] 三种状态
    "message": "状态描述" // [可选] 状态的文字描述
  }
}
```
**状态说明：**
- `processing_audio`：处理音频中
- `auto_paused`：自动暂停中（3秒静音触发）
- `manual_paused`：手动暂停中（用户主动暂停）

#### 错误信息
```json
{
  "type": "error", // [必需]
  "data": {
    "session_id": "会话ID", // [可选] 会话相关错误才包含
    "error_code": "错误代码", // [必需] 标准化错误代码
    "message": "错误描述", // [必需] 用户友好的错误描述
    "details": "详细错误信息" // [可选] 调试用的详细信息
  }
}
```

## 音频处理要求

### 录制参数
- 采样率：16000 Hz
- 声道：单声道
- 格式：建议 webm/opus
- 发送间隔：100ms

### 处理流程
1. 申请麦克风权限
2. 创建 MediaRecorder 实例
3. 定期收集音频数据块
4. 转换为 base64 格式
5. 通过 WebSocket 发送

### 语音播放
自行选择本地 tts 完成播放。

## 错误处理

### 重连机制
WebSocket 连接断开时，自动尝试重连（最多 5 次，间隔递增）。