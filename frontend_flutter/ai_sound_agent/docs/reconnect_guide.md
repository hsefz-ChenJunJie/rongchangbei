# WebSocket重连机制说明

## 功能概述

在`main_processing.dart`中添加了WebSocket重连机制，当连接中途断开时会自动尝试重新连接。

## 重连机制特点

1. **智能触发**：仅在连接建立后中途断开时触发重连，初始连接失败不触发
2. **进度保存**：每次重连前自动保存当前对话进度到`current.dp`
3. **指数退避**：重连间隔逐次增长（1s, 2s, 4s, 8s, 16s）
4. **最大重试**：最多重试5次
5. **状态提示**：通过橙色提示条显示重连进度
6. **会话保持**：重连成功后保持原有的session_id

## 重连流程

1. **检测断线**：通过WebSocket的`onDone`和`onError`回调检测
2. **保存进度**：将当前对话数据保存到`current.dp`
3. **指数退避**：按2^n秒间隔重试
4. **重新连接**：使用保存的对话数据重新建立连接
5. **恢复会话**：成功后继续原有对话

## 用户界面

- **重连提示**：橙色提示条显示"连接断开，正在重连... (当前次数/总次数)"
- **进度指示**：旋转的加载图标
- **错误处理**：达到最大重试次数后提示连接失败

## 测试方法

1. 启动应用并建立WebSocket连接
2. 等待连接成功（显示session_id）
3. 手动断开网络连接（如关闭WiFi）
4. 观察橙色重连提示条
5. 恢复网络连接，观察重连成功

## 注意事项

- 重连机制只在连接建立后中途断开时触发
- 初始连接失败会直接显示错误，不触发重连
- 重连过程中用户可以继续查看已有对话内容
- 重连成功后对话状态完全恢复