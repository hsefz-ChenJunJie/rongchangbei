# Flutter 应用打包 APK 详细指南

## 目录
- [准备工作](#准备工作)
- [配置应用信息](#配置应用信息)
- [生成签名密钥](#生成签名密钥)
- [配置签名信息](#配置签名信息)
- [构建发布版 APK](#构建发布版-apk)
- [测试 APK](#测试-apk)
- [优化与注意事项](#优化与注意事项)
- [发布应用](#发布应用)
- [常见问题解决](#常见问题解决)

---

## 准备工作

在打包前请确保：

1. **完成开发测试**：确保应用在模拟器和真机上正常运行
2. **更新 Flutter SDK**：
   ```bash
   flutter upgrade
   ```
3. **检查环境**：
   ```bash
   flutter doctor
   ```
   确保 Android toolchain 状态正常（显示 `[✓]`）

4. **安装必要工具**：
   - JDK 11+
   - Android SDK
   - Gradle

---

## 配置应用信息

### 1. 修改应用标识符
在 `android/app/build.gradle` 中：
```gradle
defaultConfig {
    applicationId "com.yourcompany.appname" // 替换为你的包名
    minSdkVersion 21
    targetSdkVersion 36 // 推荐使用最新稳定版
    versionCode 1       // 每次更新必须递增
    versionName "1.0.0"
}
```

### 2. 更新应用名称和图标
- 修改应用名称：编辑 `android/app/src/main/AndroidManifest.xml`
  ```xml
  <application
      android:label="Your App Name"  <!-- 应用名称 -->
      android:icon="@mipmap/ic_launcher"> <!-- 应用图标 -->
  ```
- 替换图标：更新 `android/app/src/main/res/mipmap-*` 目录下的图标文件

### 3. 配置权限（如需要）
在 `AndroidManifest.xml` 中添加所需权限：
```xml
<uses-permission android:name="android.permission.INTERNET"/>
<uses-permission android:name="android.permission.ACCESS_FINE_LOCATION"/>
```

---

## 生成签名密钥

### 1. 创建密钥库
```bash
keytool -genkey -v -keystore ~/upload-keystore.jks -keyalg RSA -keysize 2048 -validity 10000 -alias upload
```
- **参数说明**：
  - `-keystore`: 密钥库保存路径（推荐放在项目外）
  - `-alias`: 密钥别名（建议使用 `upload`）
  - `-validity`: 有效期天数（建议 10000+）

### 2. 安全保存密钥
记录生成的以下信息：
- 密钥库密码
- 密钥密码
- 别名
- 密钥库路径

> **⚠️ 重要**：密钥库文件（.jks）和密码是应用更新的唯一凭证，丢失将无法更新应用！

---

## 配置签名信息

### 1. 创建密钥配置文件
在 `android` 目录下创建 `key.properties`：
```properties
storePassword=your_store_password
keyPassword=your_key_password
keyAlias=upload
storeFile=/path/to/your/upload-keystore.jks
```

### 2. 配置 Gradle 使用密钥
修改 `android/app/build.gradle`：

```gradle
def keystoreProperties = new Properties()
def keystorePropertiesFile = rootProject.file('key.properties')
if (keystorePropertiesFile.exists()) {
    keystoreProperties.load(new FileInputStream(keystorePropertiesFile))
}

android {
    ...
    signingConfigs {
        release {
            keyAlias keystoreProperties['keyAlias']
            keyPassword keystoreProperties['keyPassword']
            storeFile keystoreProperties['storeFile'] ? file(keystoreProperties['storeFile']) : null
            storePassword keystoreProperties['storePassword']
        }
    }
    buildTypes {
        release {
            signingConfig signingConfigs.release
            // 启用代码混淆
            minifyEnabled true
            // 启用资源缩减
            shrinkResources true
            proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
        }
    }
}
```

---

## 构建发布版 APK

### 1. 清理项目
```bash
flutter clean
```

### 2. 构建 APK
```bash
flutter build apk --release
```

### 3. 生成分架构 APK（推荐）
减小 APK 体积：
```bash
flutter build apk --split-per-abi
```

### 4. 查找生成的 APK
- 完整 APK: `build/app/outputs/apk/release/app-release.apk`
- 分架构 APK:
  ```
  build/app/outputs/apk/release/app-armeabi-v7a-release.apk
  build/app/outputs/apk/release/app-arm64-v8a-release.apk
  build/app/outputs/apk/release/app-x86_64-release.apk
  ```

---

## 测试 APK

1. **安装到设备**：
   ```bash
   adb install build/app/outputs/apk/release/app-release.apk
   ```

2. **测试关键功能**：
   - 启动速度
   - 核心业务流程
   - 权限请求
   - 后台行为
   - 不同设备兼容性

3. **使用 Firebase Test Lab**：
   ```bash
   gcloud firebase test android run \
     --app build/app/outputs/apk/release/app-release.apk \
     --device model=Pixel4,version=30
   ```

---

## 优化与注意事项

### 优化建议
1. **减小 APK 体积**：
   - 使用 `--split-per-abi`
   - 移除未使用资源：`flutter pub run flutter_launcher_icons`
   - 压缩图片资源

2. **启用 R8 优化**：
   在 `android/gradle.properties` 中添加：
   ```properties
   android.enableR8=true
   ```

3. **配置混淆规则**：
   在 `android/app/proguard-rules.pro` 中添加 Flutter 需要的规则：
   ```proguard
   -keep class io.flutter.app.** { *; }
   -keep class io.flutter.plugin.** { *; }
   -keep class io.flutter.util.** { *; }
   -keep class io.flutter.view.** { *; }
   -keep class io.flutter.** { *; }
   -keep class io.flutter.plugins.** { *; }
   ```

### 重要注意事项
1. **目标 SDK 版本**：必须 ≥ 31（Android 12+）才能上架 Google Play
2. **权限声明**：精确声明所需权限，避免过度请求
3. **隐私政策**：如果应用收集用户数据，需提供可访问的隐私政策
4. **版本管理**：
   - `versionCode`：每次更新必须递增（整数）
   - `versionName`：用户可见的版本号（如 1.2.3）
5. **备份密钥**：将密钥库文件保存在至少两个安全位置

---

## 发布应用

### 发布到 Google Play
1. 创建 Google Play 开发者账号（$25 一次性费用）
2. 在 Play Console 创建应用
3. 准备材料：
   - 应用图标（1024×1024 PNG）
   - 功能截图（至少 2 张）
   - 应用描述和分类
   - 隐私政策链接
4. 上传 APK 到正式轨道
5. 通过内容审核（通常需要 1-7 天）

### 其他分发方式
1. **直接安装**：通过邮件/网盘分享 APK
2. **第三方商店**：华为 AppGallery、三星 Galaxy Store 等
3. **企业分发**：使用 MDM 解决方案内部发布

---

## 常见问题解决

### 1. 构建失败：`Failed to read key from keystore`
- 确保 `key.properties` 中的路径正确
- 检查密钥别名和密码是否正确
- 尝试绝对路径：`storeFile=/Users/name/path/keystore.jks`

### 2. 安装后闪退
- 检查是否配置了签名（debug 和 release 签名不同）
- 查看设备日志：
  ```bash
  adb logcat | grep flutter
  ```
- 测试 release 模式：
  ```bash
  flutter run --release
  ```

### 3. APK 体积过大
- 使用分架构构建：`--split-per-abi`
- 分析体积组成：
  ```bash
  flutter build apk --analyze-size
  ```
- 移除未使用的资源文件

### 4. 权限问题
- 在 AndroidManifest.xml 中声明所需权限
- 对于 Android 6.0+，确保实现运行时权限请求

### 5. 更新后无法覆盖安装
- 确保 `versionCode` 比前一版本大
- 检查签名是否与之前版本一致

> 遇到其他问题？尝试：
> ```bash
> flutter build apk --verbose
> ```
> 查看详细构建日志

---

通过本指南，您应该能够成功打包并发布您的 Flutter 应用。建议每次发布前进行全面测试，确保在不同设备和 Android 版本上正常运行。